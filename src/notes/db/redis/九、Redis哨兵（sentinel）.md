---
# å½“å‰é¡µé¢å†…å®¹æ ‡é¢˜
title: ä¹ã€Rediså“¨å…µï¼ˆsentinelï¼‰
# åˆ†ç±»
category:
  - redis
# æ ‡ç­¾
tag: 
  - redis
  - NOSQL
  - K,Vç¼“å­˜æ•°æ®åº“
  - éå…³ç³»å‹æ•°æ®åº“
sticky: false
# æ˜¯å¦æ”¶è—åœ¨åšå®¢ä¸»é¢˜çš„æ–‡ç« åˆ—è¡¨ä¸­ï¼Œå½“å¡«å…¥æ•°å­—æ—¶ï¼Œæ•°å­—è¶Šå¤§ï¼Œæ’åè¶Šé å‰ã€‚
star: false
# æ˜¯å¦å°†è¯¥æ–‡ç« æ·»åŠ è‡³æ–‡ç« åˆ—è¡¨ä¸­
article: true
# æ˜¯å¦å°†è¯¥æ–‡ç« æ·»åŠ è‡³æ—¶é—´çº¿ä¸­
timeline: true
---

## 01ã€æ˜¯ä»€ä¹ˆï¼Ÿ

å¹å“¨äººå·¡é€»ç›‘æ§åå°masterä¸»æœºæ˜¯å¦æ•…éšœï¼Œå¦‚æœæ•…éšœäº†æ ¹æ®`æŠ•ç¥¨æ•°`è‡ªåŠ¨å°†æŸä¸€ä¸ªä»åº“è½¬æ¢ä¸ºæ–°ä¸»åº“ï¼Œç»§ç»­å¯¹å¤–æœåŠ¡ï¼

### ä½œç”¨

å“¨å…µçš„ä½œç”¨ï¼š

`1ã€ç›‘æ§redisè¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬masterå’Œslave`

`2ã€å½“master downæœºï¼Œèƒ½è‡ªåŠ¨å°†slaveåˆ‡æ¢æˆæ–°master`

![](./images/2023-04-01-00-56-30-image.png)

> ä¿—ç§°ï¼šæ— äººå€¼å®ˆè¿ç»´

> å®˜ç½‘ç†è®ºï¼šhttps://redis.io/docs/manual/sentinel/

## 02ã€èƒ½å¹²å˜›ï¼Ÿ

![](./images/2023-04-01-00-58-06-image.png)

- ä¸»ä»ç›‘æ§

ç›‘æ§ä¸»ä»redisåº“è¿è¡Œæ˜¯å¦æ­£å¸¸

- æ¶ˆæ¯é€šçŸ¥

å“¨å…µå¯ä»¥å°†æ•…éšœè½¬ç§»çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯

- æ•…éšœè½¬ç§»

å¦‚æœmasterå¼‚å¸¸ï¼Œåˆ™ä¼šè¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œå°†å…¶ä¸­ä¸€ä¸ªSlaveä½œä¸ºæ–°Master

- é…ç½®ä¸­å¿ƒ

å®¢æˆ·ç«¯è¿æ¥å“¨å…µæ¥è·å¾—å½“å‰`redis`æœåŠ¡çš„ä¸»èŠ‚ç‚¹åœ°å€

## 03ã€æ€ä¹ˆç©ï¼ˆæ¡ˆä¾‹æ¼”ç¤ºå®æˆ˜æ­¥éª¤ï¼‰

### Redis Sentinelæ¶æ„ï¼Œå‰æè¯´æ˜

![](./images/2023-04-01-01-14-54-image.png)

- 3ä¸ªå“¨å…µ

è‡ªåŠ¨ç›‘æ§å’Œç»´æŠ¤é›†ç¾¤ï¼Œä¸å­˜æ”¾æ•°æ®ï¼Œåªæ˜¯å¹å“¨äºº

- 1ä¸»2ä»

ç”¨äºæ•°æ®è¯»å–å’Œå­˜æ”¾

### æ¡ˆä¾‹æ­¥éª¤ï¼Œä¸æœå°±å¹²

#### 1ã€/myredisç›®å½•ä¸‹æ–°å»ºæˆ–è€…æ‹·è´sentinel.confæ–‡ä»¶ï¼Œåå­—ç»å¯¹ä¸èƒ½é”™

#### 2ã€å…ˆçœ‹çœ‹/optç›®å½•ä¸‹é»˜è®¤çš„sentinel.confæ–‡ä»¶çš„å†…å®¹

![](./images/2023-04-01-01-17-09-image.png)

#### 3ã€é‡ç‚¹å‚æ•°é¡¹è¯´æ˜

- bind

æœåŠ¡ç›‘å¬åœ°å€ï¼Œç”¨äºå®¢æˆ·ç«¯è¿æ¥ï¼Œé»˜è®¤æœ¬æœºåœ°å€

- daemonize

æ˜¯å¦ä»¥åå°daemonæ–¹å¼è¿è¡Œ

- port

ç«¯å£

- logfile

æ—¥å¿—æ–‡ä»¶è·¯å¾„

- pidfile

pidæ–‡ä»¶è·¯å¾„

- dir

å·¥ä½œç›®å½•

- `sentinel monitor < master-name > < ip > < redis-port > < quorum >`

> è®¾ç½®è¦ç›‘æ§çš„masteræœåŠ¡å™¨
> 
> quorumè¡¨ç¤ºæœ€å°‘æœ‰å‡ ä¸ªå“¨å…µè®¤å¯å®¢è§‚ä¸‹çº¿ï¼ŒåŒæ„æ•…éšœè¿ç§»çš„æ³•å®šç¥¨æ•°

è¡Œå°¾æœ€åçš„quorumä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ`quorumï¼šç¡®è®¤å®¢è§‚ä¸‹çº¿çš„æœ€å°‘çš„å“¨å…µæ•°é‡`

![](./images/2023-04-01-01-21-56-image.png)

æˆ‘ä»¬çŸ¥é“ï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªsentinelä¼šå› ä¸ºç½‘ç»œå µå¡è€Œ`è¯¯ä»¥ä¸º`ä¸€ä¸ªmaster rediså·²ç»æ­»æ‰äº†ï¼Œåœ¨sentinelé›†ç¾¤ç¯å¢ƒä¸‹éœ€è¦å¤šä¸ªsentineläº’ç›¸æ²Ÿé€šæ¥ç¡®è®¤æŸä¸ªmaster`æ˜¯å¦çœŸçš„æ­»äº†`ï¼Œquorumè¿™ä¸ªå‚æ•°æ˜¯è¿›è¡Œå®¢è§‚ä¸‹çº¿çš„ä¸€ä¸ªä¾æ®ï¼Œæ„æ€æ˜¯è‡³å°‘æœ‰quorumä¸ªsentinelè®¤ä¸ºè¿™ä¸ªmasteræœ‰æ•…éšœï¼Œæ‰ä¼šå¯¹è¿™ä¸ªmasterè¿›è¡Œä¸‹çº¿ä»¥åŠæ•…éšœè½¬ç§»ã€‚å› ä¸ºæœ‰çš„æ—¶å€™ï¼ŒæŸä¸ªsentinelèŠ‚ç‚¹å¯èƒ½å› ä¸ºè‡ªèº«ç½‘ç»œåŸå› ï¼Œå¯¼è‡´æ— æ³•è¿æ¥masterï¼Œè€Œæ­¤æ—¶masterå¹¶æ²¡æœ‰å‡ºç°æ•…éšœï¼Œæ‰€ä»¥ï¼Œè¿™å°±éœ€è¦å¤šä¸ªsentineléƒ½ä¸€è‡´è®¤ä¸ºè¯¥masteræœ‰é—®é¢˜ï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿™å°±ä¿è¯äº†å…¬å¹³æ€§å’Œé«˜å¯ç”¨ã€‚

- sentinel auth-pass < master-name > < password > 

masterè®¾ç½®äº†å¯†ç ï¼Œè¿æ¥masteræœåŠ¡çš„å¯†ç 

- å…¶ä»–

```textile
sentinel down-after-milliseconds < master-name > < milliseconds >ï¼š

æŒ‡å®šå¤šå°‘æ¯«ç§’ä¹‹åï¼Œä¸»èŠ‚ç‚¹æ²¡æœ‰åº”ç­”å“¨å…µï¼Œæ­¤æ—¶å“¨å…µä¸»è§‚ä¸Šè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿



sentinel parallel-syncs < master-name > < nums >ï¼š

è¡¨ç¤ºå…è®¸å¹¶è¡ŒåŒæ­¥çš„slaveä¸ªæ•°ï¼Œå½“MasteræŒ‚äº†åï¼Œå“¨å…µä¼šé€‰å‡ºæ–°çš„Masterï¼Œæ­¤æ—¶ï¼Œå‰©ä½™çš„slaveä¼šå‘æ–°çš„masterå‘èµ·åŒæ­¥æ•°æ®



sentinel failover-timeout < master-name > < milliseconds >ï¼š

æ•…éšœè½¬ç§»çš„è¶…æ—¶æ—¶é—´ï¼Œè¿›è¡Œæ•…éšœè½¬ç§»æ—¶ï¼Œå¦‚æœè¶…è¿‡è®¾ç½®çš„æ¯«ç§’ï¼Œè¡¨ç¤ºæ•…éšœè½¬ç§»å¤±è´¥



sentinel notification-script < master-name > < script-path > ï¼š

é…ç½®å½“æŸä¸€äº‹ä»¶å‘ç”Ÿæ—¶æ‰€éœ€è¦æ‰§è¡Œçš„è„šæœ¬



sentinel client-reconfig-script < master-name > < script-path >ï¼š

å®¢æˆ·ç«¯é‡æ–°é…ç½®ä¸»èŠ‚ç‚¹å‚æ•°è„šæœ¬
```

#### 4ã€`æœ¬æ¬¡æ¡ˆä¾‹å“¨å…µsentinelæ–‡ä»¶é€šç”¨é…ç½®`

- ç”±äºæœºå™¨ç¡¬ä»¶å…³ç³»ï¼Œæˆ‘ä»¬çš„3ä¸ªå“¨å…µéƒ½åŒæ—¶é…ç½®è¿›192.168.111.169åŒä¸€å°æœºå™¨

- `sentinel26379.conf`

```textile
bind 0.0.0.0
daemonize yes
protected-mode no
port 26379
logfile "/myredis/sentinel26379.log"
pidfile /var/run/redis-sentinel26379.pid
dir /myredis
sentinel monitor mymaster 192.168.111.169 6379 2
sentinel auth-pass mymaster 111111
```

- `sentinel26380.conf`

```textile
bind 0.0.0.0
daemonize yes
protected-mode no
port 26380
logfile "/myredis/sentinel26380.log"
pidfile /var/run/redis-sentinel26380.pid
dir "/myredis"
sentinel monitor mymaster 192.168.111.169 6379 2
sentinel auth-pass mymaster 111111
```

- `sentinel26381.conf`

```textile
bind 0.0.0.0
daemonize yes
protected-mode no
port 26381
logfile "/myredis/sentinel26381.log"
pidfile /var/run/redis-sentinel26381.pid
dir "/myredis"
sentinel monitor mymaster 192.168.111.169 6379 2
sentinel auth-pass mymaster 111111
```

- è¯·çœ‹ä¸€çœ¼`sentinel26379.conf`ã€`sentinel26380.conf`ã€`sentinel26381.conf`æˆ‘ä»¬å¡«å†™çš„å†…å®¹

![](./images/2023-04-01-01-29-32-image.png)

![](./images/2023-04-01-01-29-40-image.png)

![](./images/2023-04-01-01-29-47-image.png)

- masterä¸»æœºé…ç½®æ–‡ä»¶è¯´æ˜

![](./images/2023-04-01-01-30-11-image.png)

#### 5ã€å…ˆå¯åŠ¨ä¸€ä¸»äºŒä»3ä¸ªrediså®ä¾‹ï¼Œæµ‹è¯•æ­£å¸¸çš„ä¸»ä»å¤åˆ¶

- æ¶æ„è¯´æ˜

![](./images/2023-04-01-01-31-18-image.png)

| 1   | 169æœºå™¨ä¸Šæ–°å»ºredis6379.confé…ç½®æ–‡ä»¶ï¼Œç”±äºè¦é…åˆæœ¬æ¬¡æ¡ˆä¾‹ï¼Œè¯·è®¾ç½®masterauthé¡¹è®¿é—®å¯†ç ä¸º111111ï¼Œä¸ç„¶åç»­å¯èƒ½æŠ¥é”™master_link_status:down |
| --- | ---------------------------------------------------------------------------------------------- |
| 2   | 172æœºå™¨ä¸Šæ–°å»ºredis6380.confé…ç½®æ–‡ä»¶ï¼Œè®¾ç½®å¥½replicaof < masterip > < masterport >                            |
| 3   | 173æœºå™¨ä¸Šæ–°å»ºredis6381.confé…ç½®æ–‡ä»¶ï¼Œè®¾ç½®å¥½replicaof < masterip > < masterport >                            |

- è¯·çœ‹ä¸€çœ¼`redis6379.conf`ã€`redis6380.conf`ã€`redis6381.conf`æˆ‘ä»¬è‡ªå·±å¡«å†™ä¸»ä»å¤åˆ¶ç›¸å…³çš„å†…å®¹

> ä¸»æœº6379

![](./images/2023-04-01-01-33-28-image.png)

6379åç»­å¯èƒ½ä¼šå˜æˆä»æœºï¼Œéœ€è¦è®¾ç½®è®¿é—®æ–°ä¸»æœºçš„å¯†ç ï¼ŒÂ è¯·è®¾ç½®masterauthé¡¹è®¿é—®å¯†ç ä¸º111111ï¼Œ

`ä¸ç„¶åç»­å¯èƒ½æŠ¥é”™master_link_status:down`

> 6380

![](./images/2023-04-01-01-34-02-image.png)

å…·ä½“IPåœ°å€å’Œå¯†ç æ ¹æ®ä½ æœ¬åœ°çœŸå®æƒ…å†µï¼Œé…Œæƒ…ä¿®æ”¹

> 6381

![](./images/2023-04-01-01-34-24-image.png)

å…·ä½“IPåœ°å€å’Œå¯†ç æ ¹æ®ä½ æœ¬åœ°çœŸå®æƒ…å†µï¼Œé…Œæƒ…ä¿®æ”¹

- 3å°ä¸åŒçš„è™šæ‹Ÿæœºå®ä¾‹ï¼Œå¯åŠ¨ä¸‰éƒ¨çœŸå®æœºå™¨å®ä¾‹å¹¶è¿æ¥

> redis-cli -a 111111 -p 6379

> redis-cli -a 111111 -p 6380

> redis-cli -a 111111 -p 6381

- å…·ä½“æŸ¥çœ‹å½“å ‚åŠ¨æ‰‹æ¡ˆä¾‹é…ç½®å¹¶è§‚å¯Ÿæ–‡ä»¶å†…å®¹

#### =========ä»¥ä¸‹æ˜¯å“¨å…µå†…å®¹éƒ¨åˆ†=========

#### 6ã€åœ¨å¯åŠ¨3ä¸ªå“¨å…µï¼Œå®Œæˆç›‘æ§

- redis-sentinel sentinel26379.conf --sentinel

- redis-sentinel sentinel26380.conf --sentinel

- redis-sentinel sentinel26381.conf --sentinel

#### 7ã€å¯åŠ¨3ä¸ªå“¨å…µç›‘æ§åå†æµ‹è¯•ä¸€æ¬¡ä¸»ä»å¤åˆ¶

`å²æœˆé™å¥½ä¸€åˆ‡OK`

![](./images/2023-04-01-01-41-50-image.png)

![](./images/2023-04-01-01-41-59-image.png)

#### 8ã€åŸæœ‰çš„masteræŒ‚äº†

1. æˆ‘ä»¬æ‰‹åŠ¨å…³é—­6379æœåŠ¡å™¨ï¼Œæ¨¡æ‹ŸmasteræŒ‚äº†

![](./images/2023-04-01-01-49-42-image.png)

2. â“é—®é¢˜æ€è€ƒ

ä¸¤å°ä»æœºæ•°æ®æ˜¯å¦ok

æ˜¯å¦ä¼šå‰©ä¸‹çš„2å°æœºå™¨ä¸Šé€‰å‡ºæ–°çš„master

ä¹‹å‰downæœºçš„masteræœºå™¨é‡æ–°å›æ¥ï¼Œè°å°†æ˜¯æ–°è€å¤§ï¼Ÿä¼šä¸ä¼šåŒmasterå†²çªï¼Ÿ

3. ğŸ“šæ­æ™“ç­”æ¡ˆ
- æ•°æ®OK

> ä¸¤ä¸ªå°é—®é¢˜

![](./images/2023-04-01-01-54-41-image.png)

![](./images/2023-04-01-01-54-50-image.png)

> 6380

![](./images/2023-04-01-01-55-16-image.png)

> 6381

![](./images/2023-04-01-01-55-41-image.png)

> äº†è§£Broken pipe

| è®¤è¯†broken pipe  | pipeæ˜¯ç®¡é“çš„æ„æ€ï¼Œç®¡é“é‡Œé¢æ˜¯æ•°æ®æµï¼Œé€šå¸¸æ˜¯ä»æ–‡ä»¶æˆ–ç½‘ç»œå¥—æ¥å­—è¯»å–çš„æ•°æ®ã€‚å½“è¯¥ç®¡é“ä»å¦ä¸€ç«¯çªç„¶å…³é—­æ—¶ï¼Œä¼šå‘ç”Ÿæ•°æ®çªç„¶ä¸­æ–­ï¼Œå³æ˜¯brokenï¼Œå¯¹äºsocketæ¥è¯´ï¼Œå¯èƒ½æ˜¯ç½‘ç»œè¢«æ‹”å‡ºæˆ–å¦ä¸€ç«¯çš„è¿›ç¨‹å´©æºƒ |
| -------------- | --------------------------------------------------------------------------------------------------- |
| è§£å†³é—®é¢˜           | å…¶å®å½“è¯¥å¼‚å¸¸äº§ç”Ÿçš„æ—¶å€™ï¼Œå¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å¤šå°‘å½±å“ã€‚å› ä¸ºå¯èƒ½æ˜¯æŸä¸ªå®¢æˆ·ç«¯çªç„¶ä¸­æ­¢äº†è¿›ç¨‹å¯¼è‡´äº†è¯¥é”™è¯¯                                                 |
| æ€»ç»“ Broken Pipe | è¿™ä¸ªå¼‚å¸¸æ˜¯å®¢æˆ·ç«¯è¯»å–è¶…æ—¶å…³é—­äº†è¿æ¥,è¿™æ—¶å€™æœåŠ¡å™¨ç«¯å†å‘å®¢æˆ·ç«¯å·²ç»æ–­å¼€çš„è¿æ¥å†™æ•°æ®æ—¶å°±å‘ç”Ÿäº†broken pipeå¼‚å¸¸ï¼                                         |

![](./images/2023-04-01-01-56-21-image.png)

- æŠ•ç¥¨æ–°é€‰

> sentinel26379.log

![](./images/2023-04-01-01-57-17-image.png)

> sentinel26380.log

![](./images/2023-04-01-01-57-49-image.png)

> sentinel26381.log

![](./images/2023-04-01-01-58-13-image.png)

- è°æ˜¯masterï¼Œé™æœ¬æ¬¡æ¡ˆä¾‹

> 6381è¢«é€‰ä¸ºmasterï¼Œä¸Šä½æˆåŠŸ

![](./images/2023-04-01-01-59-03-image.png)

> ä»¥å‰çš„6379ä»masteré™çº§ä¸ºslave

![](./images/2023-04-01-01-59-38-image.png)

> 6380è¿˜æ˜¯slaveï¼Œåªä¸è¿‡æ¢äº†ä¸ªæ–°è€å¤§6381ï¼ˆ6379å˜6381ï¼‰ï¼Œ6380è¿˜æ˜¯slave

#### 9ã€å¯¹æ¯”é…ç½®æ–‡ä»¶

- vim sentinel26379.conf

- è€masterï¼Œvim redis6379.conf

- æ–°masterï¼Œvim redis6381.conf

- ç»“è®º

æ–‡ä»¶çš„å†…å®¹ï¼Œåœ¨è¿è¡ŒæœŸé—´ä¼šè¢«sentinelåŠ¨æ€è¿›è¡Œä¿®æ”¹

Master-Slaveåˆ‡æ¢åï¼Œmaster_redis.confã€slave_redis.confå’Œsentinel.confçš„å†…å®¹éƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå³master_redis.confä¸­ä¼šå¤šä¸€è¡Œslaveofçš„é…ç½®ï¼Œsentinel.confçš„ç›‘æ§ç›®æ ‡ä¼šéšä¹‹è°ƒæ¢

### å…¶ä»–å¤‡æ³¨

ç”Ÿäº§æ—¶ä¸åŒæœºæˆ¿ä¸åŒæœåŠ¡å™¨ï¼Œå¾ˆå°‘å‡ºç°3ä¸ªå“¨å…µå…¨æŒ‚æ‰çš„æƒ…å†µ

å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªmasterï¼Œä¸€è¡Œä¸€ä¸ª

## 04ã€å“¨å…µè¿è¡Œæµç¨‹å’Œé€‰ä¸¾åŸç†

å½“ä¸€ä¸ªä¸»ä»é…ç½®ä¸­çš„masterå¤±æ•ˆä¹‹åï¼Œsentinelå¯ä»¥é€‰ä¸¾å‡ºÂ Â Â Â ä¸€ä¸ªæ–°çš„master

ç”¨äºè‡ªåŠ¨æ¥æ›¿åŸmsterçš„å·¥ä½œï¼Œä¸»ä»é…ç½®ä¸­çš„å…¶ä»–redisæœåŠ¡å™¨è‡ªåŠ¨æŒ‡å‘æ–°çš„masteråŒæ­¥æ•°æ®ã€‚

ä¸€èˆ¬å»ºè®®sentinelé‡‡å–`å¥‡æ•°å°`ï¼Œé˜²æ­¢æŸä¸€å°sentinelæ— æ³•è¿æ¥åˆ°masterå¯¼è‡´è¯¯åˆ‡æ¢

### è¿è¡Œæµç¨‹ï¼Œæ•…éšœåˆ‡æ¢

#### 1ã€ä¸‰ä¸ªå“¨å…µç›‘æ§ä¸€ä¸»äºŒä»ï¼Œæ­£å¸¸è¿è¡Œä¸­......

![](./images/2023-04-01-02-15-30-image.png)

#### 2ã€SDownä¸»è§‚ä¸‹çº¿ï¼ˆSubjectively Downï¼‰

- SDOWNï¼ˆä¸»è§‚ä¸å¯ç”¨ï¼‰æ˜¯å•ä¸ªsentinelè‡ªå·±ä¸»è§‚ä¸Šæ£€æµ‹åˆ°å…³äºmasterçš„çŠ¶æ€ï¼Œä»sentinelçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœå‘é€äº†PINGå¿ƒè·³åï¼Œåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åˆæ³•çš„å›å¤ï¼Œå°±è¾¾åˆ°äº†SDOWNçš„æ¡ä»¶

- sentinelé…ç½®æ–‡ä»¶ä¸­çš„down-after-millisecondsè®¾ç½®äº†åˆ¤æ–­ä¸»è§‚ä¸‹çº¿çš„æ—¶é—´é•¿åº¦

- è¯´æ˜

æ‰€è°“ä¸»è§‚ä¸‹çº¿ï¼ˆSubjectively Downï¼Œ ç®€ç§° SDOWNï¼‰æŒ‡çš„æ˜¯å•ä¸ªSentinelå®ä¾‹å¯¹æœåŠ¡å™¨åšå‡ºçš„ä¸‹çº¿åˆ¤æ–­ï¼Œå³å•ä¸ªsentinelè®¤ä¸ºæŸä¸ªæœåŠ¡ä¸‹çº¿ï¼ˆæœ‰å¯èƒ½æ˜¯æ¥æ”¶ä¸åˆ°è®¢é˜…ï¼Œä¹‹é—´çš„ç½‘ç»œä¸é€šç­‰ç­‰åŸå› ï¼‰ã€‚ä¸»è§‚ä¸‹çº¿å°±æ˜¯è¯´å¦‚æœæœåŠ¡å™¨åœ¨[sentinel down-after-milliseconds]ç»™å®šçš„æ¯«ç§’æ•°ä¹‹å†…æ²¡æœ‰å›åº”PINGå‘½ä»¤æˆ–è€…è¿”å›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œ é‚£ä¹ˆè¿™ä¸ªSentinelä¼šä¸»è§‚çš„(å•æ–¹é¢çš„)è®¤ä¸ºè¿™ä¸ªmasterä¸å¯ä»¥ç”¨äº†ï¼Œo(â•¥ï¹â•¥)o

![](./images/2023-04-01-02-18-15-image.png)

sentinel down-after-milliseconds < masterName > < timeout >

Â è¡¨ç¤ºmasterè¢«å½“å‰sentinelå®ä¾‹è®¤å®šä¸ºå¤±æ•ˆçš„é—´éš”æ—¶é—´ï¼Œè¿™ä¸ªé…ç½®å…¶å®å°±æ˜¯è¿›è¡Œä¸»è§‚ä¸‹çº¿çš„ä¸€ä¸ªä¾æ®

masteråœ¨å¤šé•¿æ—¶é—´å†…ä¸€ç›´æ²¡æœ‰ç»™Sentineè¿”å›æœ‰æ•ˆä¿¡æ¯ï¼Œåˆ™è®¤å®šè¯¥masterä¸»è§‚ä¸‹çº¿ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœå¤šä¹…æ²¡è”ç³»ä¸Šredis-servevrï¼Œè®¤ä¸ºè¿™ä¸ªredis-serverè¿›å…¥åˆ°å¤±æ•ˆï¼ˆSDOWNï¼‰çŠ¶æ€ã€‚

#### 3ã€ODownå®¢è§‚ä¸‹çº¿ï¼ˆObjectively Downï¼‰

- ODOWNéœ€è¦ä¸€å®šæ•°é‡çš„sentinelï¼Œ`å¤šä¸ªå“¨å…µæ‰“æˆä¸€è‡´æ„è§`æ‰èƒ½è®¤ä¸ºä¸€ä¸ªmasterå®¢è§‚ä¸Šå·²ç»å®•æœºäº†

- è¯´æ˜

å››ä¸ªå‚æ•°å«ä¹‰ï¼š

masterNameæ˜¯å¯¹æŸä¸ªmaster+slaveç»„åˆçš„ä¸€ä¸ªåŒºåˆ†æ ‡è¯†(ä¸€å¥—sentinelå¯ä»¥ç›‘å¬å¤šç»„master+slaveè¿™æ ·çš„

![](./images/2023-04-01-07-06-47-image.png)

**quorumè¿™ä¸ªå‚æ•°æ˜¯è¿›è¡Œå®¢è§‚ä¸‹çº¿çš„ä¸€ä¸ªä¾æ®**ï¼Œæ³•å®šäººæ•°/æ³•å®šç¥¨æ•°

æ„æ€æ˜¯è‡³å°‘æœ‰quorumä¸ªsentinelè®¤ä¸ºè¿™ä¸ªmasteræœ‰æ•…éšœæ‰ä¼šå¯¹è¿™ä¸ªmasterè¿›è¡Œä¸‹çº¿ä»¥åŠæ•…éšœè½¬ç§»ã€‚å› ä¸ºæœ‰çš„æ—¶å€™ï¼ŒæŸä¸ªsentinelèŠ‚ç‚¹å¯èƒ½å› ä¸ºè‡ªèº«ç½‘ç»œåŸå› å¯¼è‡´æ— æ³•è¿æ¥masterï¼Œè€Œæ­¤æ—¶masterå¹¶æ²¡æœ‰å‡ºç°æ•…éšœï¼Œæ‰€ä»¥è¿™å°±éœ€è¦å¤šä¸ªsentineléƒ½ä¸€è‡´è®¤ä¸ºè¯¥masteræœ‰é—®é¢˜ï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿™å°±ä¿è¯äº†å…¬å¹³æ€§å’Œé«˜å¯ç”¨ã€‚

#### 4ã€é€‰å‡ºé¢†å¯¼è€…å“¨å…µï¼ˆå“¨å…µä¸­é€‰å‡ºå…µç‹ï¼‰

![](./images/2023-04-01-07-12-58-image.png)

å½“ä¸»èŠ‚ç‚¹è¢«åˆ¤æ–­å®¢è§‚ä¸‹çº¿ä»¥åï¼Œå„ä¸ªå“¨å…µèŠ‚ç‚¹ä¼šè¿›è¡Œåå•†ï¼Œå…ˆé€‰å‡ºä¸€ä¸ª`é¢†å¯¼è€…å“¨å…µèŠ‚ç‚¹ï¼ˆå…µç‹ï¼‰`å¹¶ç”±è¯¥é¢†å¯¼è€…èŠ‚ç‚¹ï¼Œä¹Ÿå³è¢«é€‰å‡ºçš„å…µç‹è¿›è¡Œfailoverï¼ˆæ•…éšœè¿ç§»ï¼‰

> ä¸‰å“¨å…µæ—¥å¿—æ–‡ä»¶2æ¬¡è§£è¯»åˆ†æ

- sentinel26379.log

![](./images/2023-04-01-07-10-44-image.png)

- sentinel26380.log

![](./images/2023-04-01-07-11-08-image.png)

- sentinel26381.log

![](./images/2023-04-01-07-11-39-image.png)

å“¨å…µé¢†å¯¼è€…ï¼Œå…µç‹å¦‚ä½•é€‰å‡ºæ¥çš„ï¼Ÿ

- Raftç®—æ³•

![](./images/2023-04-01-07-12-20-image.png)

ç›‘è§†è¯¥ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰å“¨å…µéƒ½æœ‰å¯èƒ½è¢«é€‰ä¸ºé¢†å¯¼è€…ï¼Œé€‰ä¸¾ä½¿ç”¨çš„ç®—æ³•æ˜¯Raftç®—æ³•ï¼›Raftç®—æ³•çš„åŸºæœ¬æ€è·¯**æ˜¯å…ˆåˆ°å…ˆå¾—**ï¼š

å³åœ¨ä¸€è½®é€‰ä¸¾ä¸­ï¼Œå“¨å…µAå‘Bå‘é€æˆä¸ºé¢†å¯¼è€…çš„ç”³è¯·ï¼Œå¦‚æœBæ²¡æœ‰åŒæ„è¿‡å…¶ä»–å“¨å…µï¼Œåˆ™ä¼šåŒæ„Aæˆä¸ºé¢†å¯¼è€…

#### 5ã€ç”±å…µç‹å¼€å§‹æ¨åŠ¨æ•…éšœåˆ‡æ¢æµç¨‹å¹¶é€‰å‡ºä¸€ä¸ªæ–°master

##### 3æ­¥éª¤

###### æ–°ä¸»ç™»åŸº

- æŸä¸ªslaveè¢«é€‰ä¸­æˆä¸ºæ–°master

- é€‰å‡ºæ–°masterçš„è§„åˆ™ï¼Œå‰©ä½™slaveèŠ‚ç‚¹å¥åº·å‰æä¸‹

![](./images/2023-04-01-07-15-15-image.png)

redis.confæ–‡ä»¶ä¸­ï¼Œä¼˜å…ˆçº§slave-priorityæˆ–è€…replica-priorityæœ€é«˜çš„ä»èŠ‚ç‚¹ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰

![](./images/2023-04-01-07-16-28-image.png)

å¤åˆ¶åç§»ä½ç½®offsetæœ€å¤§çš„ä»èŠ‚ç‚¹

æœ€å°Run IDçš„ä»èŠ‚ç‚¹

> å­—å…¸é¡ºåºï¼ŒASCIIIç 

###### ç¾¤è‡£ä¿¯é¦–

- **ä¸€æœå¤©å­ä¸€æœè‡£ï¼Œæ¢ä¸ªç å¤´é‡æ–°æ‹œ**

- æ‰§è¡Œé‚£ä¸ªslaveof no oneå‘½ä»¤è®©é€‰å‡ºæ¥çš„ä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡slaveofå‘½ä»¤è®©å…¶ä»–èŠ‚ç‚¹æˆä¸ºå…¶ä»èŠ‚ç‚¹

- Sentinel leaderä¼šå¯¹é€‰ä¸¾å‡ºçš„æ–°masteræ‰§è¡Œslaveof no oneæ“ä½œï¼Œå°†å…¶æå‡ä¸ºmasterèŠ‚ç‚¹

- Sentinel leaderå‘å…¶ä»–slaveå‘é€å‘½ä»¤ï¼Œè®©å‰©ä¸‹çš„salveæˆä¸ºæ–°çš„masterèŠ‚ç‚¹çš„slave

###### æ—§ä¸»æ‹œæœ

- **è€masterå›æ¥ä¹Ÿè®¤æ€‚**

- å°†ä¹‹å‰å·²ä¸‹çº¿çš„è€masterè®¾ç½®ä¸ºæ–°é€‰å‡ºçš„æ–°masterçš„ä»èŠ‚ç‚¹ï¼Œå½“è€masteré‡æ–°ä¸Šçº¿åï¼Œå®ƒä¼šæˆä¸ºæ–°masterçš„ä»èŠ‚ç‚¹

- Sentinel leaderä¼šè®©åŸæ¥çš„masteré™çº§ä¸ºslaveå¹¶æ¢å¤å·¥ä½œ

##### å°æ€»ç»“

ä¸Šè¿°çš„failoveræ“ä½œå‡ç”±sentinelè‡ªå·±ç‹¬ç«‹å®Œæˆï¼Œå®Œå…¨æ— éœ€äººå·¥å¹²é¢„ã€‚

![](./images/2023-04-01-08-36-08-image.png)

## 05ã€å“¨å…µä½¿ç”¨å»ºè®®

- å“¨å…µèŠ‚ç‚¹çš„æ•°é‡åº”ä¸ºå¤šä¸ªï¼Œå“¨å…µæœ¬èº«åº”è¯¥é›†ç¾¤ï¼Œä¿è¯é«˜å¯ç”¨

- å“¨å…µèŠ‚ç‚¹çš„æ•°é‡åº”è¯¥æ˜¯å¥‡æ•°

- å„ä¸ªå“¨å…µèŠ‚ç‚¹çš„é…ç½®åº”ä¸€è‡´

- å¦‚æœå“¨å…µèŠ‚ç‚¹éƒ¨ç½²åœ¨Dockerç­‰å®¹å™¨é‡Œé¢æ²¡æœ‰èµ·è¦æ³¨æ„ç«¯å£çš„æ­£ç¡®æ˜ å°„

- å“¨å…µé›†ç¾¤+ä¸»ä»å¤åˆ¶ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°æ®é›¶ä¸¢å¤±
  
  - æ‰¿ä¸Šå¯ä¸‹å¼•å‡ºé›†ç¾¤
